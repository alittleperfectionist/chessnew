<!DOCTYPE html>
<html lang="en">
    <head>
        <!--        <meta name="viewport" id="viewport"
                      content="width=device-width, height=device-height,
                      initial-scale=1.0, maximum-scale=1.0,
                      user-scalable=no" />-->

        <title>Bootstrap 3, from LayoutIt!</title>
        <!--<meta name="viewport" content="width=device-width, initial-scale=1.0">-->
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, target-densitydpi=medium-dpi, user-scalable=0" />
        <meta name="description" content="">
        <meta name="author" content="">

        <!--link rel="stylesheet/less" href="less/bootstrap.less" type="text/css" /-->
        <!--link rel="stylesheet/less" href="less/responsive.less" type="text/css" /-->
        <!--script src="js/less-1.3.3.min.js"></script-->
        <!--append ‘#!watch’ to the browser URL, then refresh the page. -->

        <link href="css/bootstrap.min.css" rel="stylesheet">
        <link href="css/style.css" rel="stylesheet">
        <link rel="stylesheet" href="css/chessboard.css">
        <link rel="stylesheet" href="css/fontcustom.css">


        <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
        <!--[if lt IE 9]>
          <script src="js/html5shiv.js"></script>
        <![endif]-->

        <!-- Fav and touch icons -->
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="img/apple-touch-icon-144-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="img/apple-touch-icon-114-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="img/apple-touch-icon-72-precomposed.png">
        <link rel="apple-touch-icon-precomposed" href="img/apple-touch-icon-57-precomposed.png">
        <link rel="shortcut icon" href="img/favicon.png">

        <style>
            /*            .myicon-custom-knight {
                                            content: "\0000a0";
                                            background-image: url("img/knight.png");
                                            width: 140px;
                                            height: 140px;
                                            position: 
                            display: inline-block;
                            width: 14px;
                            height: 14px;
                            *margin-right: .3em;
                            line-height: 14px;
                            vertical-align: text-top;
                            background-position: 14px 14px;
                            background-repeat: no-repeat;
                            background-image: url("img/knight.png");
                            margin-top: 1px;
                        }*/

            .customicon {
                position: relative;
                top: 1px;
                display: inline-block;
                /*font-family: 'Glyphicons Halflings';*/
                font-style: normal;
                font-weight: normal;
                background-repeat: no-repeat;
                vertical-align: text-top;
                line-height: 1;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;

                &:empty {
                    width: 1em;
                }
            }

            /*.customicon-knight{ &:before { content: "\2a"; } }*/
            .customicon-knight{
                content: "\0000a0";
                background-image: url("img/knight.png");
                height: 14px; 
                width: 14px;
                background-position: center center;
            }



            /*.icon-custom-intheoffice { background-position: -395px -60px; width: 24px; height: 24px  }*/ 
        </style>

        <script type="text/javascript" src="js/jquery.min.js"></script>
        <script type="text/javascript" src="js/bootstrap.min.js"></script>

        <script type="text/javascript" src="js/scripts.js"></script>
        <!--<script type="text/javascript" src="js/css3-mediaqueries.js"></script>-->

    </head>

    <body>
        <script>
//            window.fbAsyncInit = function () {
//                FB.init({
//                    appId: '760086264112934',
//                    xfbml: true,
//                    version: 'v2.1',
//                    status: true
//                });
//            };
//            (function (d, s, id) {
//                var js, fjs = d.getElementsByTagName(s)[0];
//                if (d.getElementById(id)) {
//                    return;
//                }
//                js = d.createElement(s);
//                js.id = id;
//                js.src = "//connect.facebook.net/en_US/sdk.js";
//                fjs.parentNode.insertBefore(js, fjs);
//            }(document, 'script', 'facebook-jssdk'));
//            function login() {
//                FB.getLoginStatus(function (r) { //check if user already authorized the app
//                    if (r.status === 'connected') {
//                        window.location.href = 'fbconnect.php';
//                    } else {
//                        FB.login(function (response) { // opens the login dialog
//                            if (response.authResponse) { // check if user authorized the app
//                                //if (response.perms) {
////                                window.location.href = 'fbconnect.php';
//                                alert('authorized');
//                            } else {
//                                // user is not logged in
//                            }
//                        }, {scope: 'email'}); //permission required by the app
//                    }
//                });
//            }
        </script>
        <div class="container" style="width: 100%;max-height: 100%;">
            <div class="row clearfix" style="background-color: #777777;padding-left: 0%;">
                <div class="col-xs-2 column" style="">
                    <!--			<img alt="140x140" src="http://lorempixel.com/140/140/">-->
                    <i id="icon-knighticon" class="icon-knighticon" style="font-size: 4vw"></i>
                </div>
                <div class="col-xs-5 column" style="text-align: center;color: white">
                    <!--                    <img alt="140x140" src="http://lorempixel.com/140/140/">-->
                    <div style="font-size: 5vw;padding-top: 5%;">
                        Chess Ranking
                    </div>
                </div>
                <div class="col-xs-3 column" style="">
                    <div style="text-align: left;font-size: 2.5vw;">
                        Level 12
                    </div>
                    <div class="progress" style="height: 1vw;">
                        <div class="progress-bar progress-bar-danger" style="width: 70%;">
                        </div>
                    </div>
                </div>
                <div class="col-xs-2 column">
                    <!--<img alt="140x140" src="http://lorempixel.com/140/140/">-->
                    <i class="glyphicon glyphicon-cloud" style="font-size: 4vw;float: right"></i>
                </div>
            </div>
            <div class="row clearfix" style="">
                <div class="col-xs-3 column">
                </div>
                <div class="col-xs-6 column">
                    <div style="text-align: center;color: #777777;font-weight: bold;font-size: 2.5vw;">
                        White Moves and Wins in 2 Moves
                    </div>
                </div>
                <div class="col-xs-3 column">
                </div>
            </div>
            <div class="row clearfix" style="">
                <div class="col-xs-3 column">
                    <!--                    <img alt="140x140" src="http://lorempixel.com/140/140/">-->

                </div>
                <div class="col-xs-6 column">
                    <!--<img alt="140x140" src="http://lorempixel.com/140/140/">-->
                    <!--<i class="glyphicon glyphicon-cloud" style="font-size: 550%;float: left;"></i>-->
                    <div style="text-align: center;color: #777777;font-weight: bold;float: left;font-size: 3vw">
                        1/10
                    </div>
                    <i class="glyphicon glyphicon-heart" style="font-size: 2.5vw;padding-left: 35%;color: darkred;padding-top: 2%;"></i>
                    <i class="glyphicon glyphicon-heart" style="font-size: 2.5vw;padding-left: 5%;color: darkred;"></i>
                    <i class="glyphicon glyphicon-heart" style="font-size: 2.5vw;padding-left: 5%;color: darkred;"></i>

                    <i class="glyphicon glyphicon-cloud" style="font-size: 2.5vw;float: right;"></i>
                </div>
                <div class="col-xs-3 column">
                    <!--<img alt="140x140" src="http://lorempixel.com/140/140/">-->
                </div>
            </div>
            <div class="row clearfix" style="">
                <div class="col-xs-3 column">
                    <!--<img alt="140x140" src="http://lorempixel.com/140/140/">-->
                </div>
                <div class="col-xs-6 column">
                    <!--<img alt="140x140" src="http://lorempixel.com/140/140/">-->
                    <div id="board" style="width: 50vw;"></div>
                </div>
                <div class="col-xs-3 column">
                    <!--<img alt="140x140" src="http://lorempixel.com/140/140/">-->
                </div>
            </div>
            <div class="row clearfix" style="">
                <div class="col-xs-3 column">
                    <!--<img alt="140x140" src="http://lorempixel.com/140/140/">-->
                </div>
                <div class="col-xs-6 column">
                    <div style="text-align: center;color: #777777;font-size: 2.1vw;">
                        Book of the Counties' Chess Association, 1887
                    </div>
                </div>
                <div class="col-xs-3 column">
                    <!--<img alt="140x140" src="http://lorempixel.com/140/140/">-->
                </div>
            </div>
            <div class="row clearfix" style="">
                <div class="col-xs-3 column">
                    <!--<img alt="140x140" src="http://lorempixel.com/140/140/">-->
                </div>
                <div class="col-xs-6 column" style="background-color: white;margin-left: 1vw;">
                    <div style="color: #999999;float:left;font-size: 2vw;">Abbott, Joseph William</div>
                    <div style="color: #999999;float:right;font-size: 2vw;">Difficulty: 2</div>
                    <br>
                    <br>
                    <br>
                    <i class="glyphicon glyphicon-cloud" style="font-size: 3vw;float: left;"></i>
                    <i class="glyphicon glyphicon-time" style="font-size: 3vw;float: left;color: #777777;padding-left: 5%;"></i>
                    <i class="glyphicon glyphicon-flag" style="font-size: 3vw;float: left;color: #777777;padding-left: 10%;"></i>

                    <!--<i class="glyphicon glyphicon-cloud" style="font-size: 550%;float: right;"></i>-->
                    <div style="width: 25vw;float: right;padding-left: 10vw;">
                        <button class="btn btn-primary" onclick="login()" style="width: 7vw;font-size: 120%;text-align: left;white-space: normal;font-size: 1vw;">
                            Share
                        </button>
                        <button class="btn btn-success" style="width: 7vw;font-size: 120%;text-align: left;white-space: normal;font-size: 1vw;">
                            Share
                        </button>
                    </div>

                    <!--<i class="glyphicon glyphicon-cloud" style="font-size: 550%;float: right;"></i>-->
                </div>
                <div class="col-xs-3 column">
                    <!--<img alt="140x140" src="http://lorempixel.com/140/140/">-->
                </div>
            </div>
            <div class="row clearfix" style="">
                <div class="col-xs-3 column" style="text-align: center;background-color: #777777">
                    <!--<img alt="140x140" src="http://lorempixel.com/140/140/">-->
                    <i class="glyphicon glyphicon-cloud" style="font-size: 5vw;"></i>
                    <!--<button class="btn btn-success"></button>-->
                </div>
                <div class="col-xs-2 column" style="text-align: center;background-color: #999999">
                    <!--<img alt="140x140" src="http://lorempixel.com/140/140/">-->
                    <i class="glyphicon glyphicon-cloud" style="font-size: 5vw;"></i>
                </div>
                <div class="col-xs-2 column" style="text-align: center;">
                    <!--<img alt="140x140" src="http://lorempixel.com/140/140/">-->
                    <i class="glyphicon glyphicon-cloud" style="font-size: 5vw;"></i>
                </div>
                <div class="col-xs-2 column" style="text-align: center;background-color: #999999">
                    <!--<img alt="140x140" src="http://lorempixel.com/140/140/">-->
                    <i class="glyphicon glyphicon-cloud" style="font-size: 5vw;"></i>
                </div>
                <div class="col-xs-3 column" style="text-align: center;background-color: #777777">
                    <!--<img alt="140x140" src="http://lorempixel.com/140/140/">-->
                    <i class="glyphicon glyphicon-user" style="font-size: 5vw;"></i>
                </div>
            </div>
        </div>
        <div class="modal fade" id="myModal" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                        <h4 class="modal-title" id="myModalLabel">
                            Modal title
                        </h4>
                    </div>
                    <div class="modal-body">
                        <!--<button onclick="login()">Login</button>-->
                        <div id="fb-root"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" onclick="keepPlaying()" class="btn btn-default" data-dismiss="modal">Keep Playing</button> 
                        <button type="button" onclick="login()" class="btn btn-primary">Login</button>
                    </div>
                </div>

            </div>

        </div>


        <script src="js/chess.js"></script>
        <script src="js/chessboard.js"></script>

        <script src="js/phonegap.js"></script>
        <!--<script src="js/cordova1.js"></script>-->
        <!-- cordova facebook plugin -->
        <script src="js/cdv-plugin-fb-connect.js"></script>
        <!-- facebook js sdk -->
        <script src="js/facebook-js-sdk.js"></script>
        <script>

                            var board,
                                    game = new Chess(),
                                    statusEl = $('#status'),
                                    fenEl = $('#fen'),
                                    pgnEl = $('#pgn');
                            var isRegistered = false;
                            var hasPlayedBefore = false;
                            var file = {
                                writer: {available: false},
                                reader: {available: false}
                            };
                            var dbEntries = [];
                            var FILENAME = 'data/db.json';
                            var gold_badge = 1, silver_badge = 1, bronze_badge = 1, excellent_badge = 1;

                            var total_gold_badge = 1, total_silver_badge = 1, total_bronze_badge = 1, total_excellent_badge = 1;
                            var badge_of_day = 1;
                            var total_days = 1;


                            //
                            var user_name;
                            var user_email;
                            //

                            var onDragStart = function(source, piece, position, orientation) {
                                if (game.game_over() === true ||
                                        (game.turn() === 'w' && piece.search(/^b/) !== -1) ||
                                        (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
                                    return false;
                                }
                            };
                            var onDrop = function(source, target) {
                                // see if the move is legal
                                var move = game.move({
                                    from: source,
                                    to: target,
                                    promotion: 'q' // NOTE: always promote to a queen for example simplicity
                                });
                                if (!isRegistered) {
                                    $('#myModal').modal('show');
//                                    createNewFileInDevice();
                                }

                                // illegal move
                                if (move === null)
                                    return 'snapback';
                                updateStatus();
                            };
// update the board position after the piece snap 
// for castling, en passant, pawn promotion
                            var onSnapEnd = function() {
                                board.position(game.fen());
                            };
                            var updateStatus = function() {
                                var status = '';
                                var moveColor = 'White';
                                if (game.turn() === 'b') {
                                    moveColor = 'Black';
                                }

                                // checkmate?
                                if (game.in_checkmate() === true) {
                                    status = 'Game over, ' + moveColor + ' is in checkmate.';
                                    //assume problem is solved
                                    var rating = calculateRating();
                                    updateRating(rating);
                                    //TODO: Push this rating to database
                                }

                                // draw?
                                else if (game.in_draw() === true) {
                                    status = 'Game over, drawn position';
                                }

                                // game still on
                                else {
                                    status = moveColor + ' to move';
                                    // check?
                                    if (game.in_check() === true) {
                                        status += ', ' + moveColor + ' is in check';
                                    }
                                }

                            };
                            var cfg = {
                                draggable: true,
                                position: 'start',
                                onDragStart: onDragStart,
                                onDrop: onDrop,
                                onSnapEnd: onSnapEnd
                            };


                            loadFen = function() {
                                var id = 1;
                                $.ajax({
                                    url: 'http://chessgame.orgfree.com/readData.php?id=1',
//                    dataType: 'json',
//                    contentType: 'application/json',
                                    success: function(response) {
                                        var data = JSON.parse(response);
//                        board.position(data.fen);
                                        board.position('7n/3NR3/1P3p2/1p1kbN1B/1p6/1K6/6b1/1Q6');
//                        alert(game.load());
                                    },
                                    error: function(response) {
                                        alert('error in loading FEN String from database');
                                        alert(response);
                                    }
                                });
                            };



        </script>

        <script>
            if ((typeof cordova == 'undefined') && (typeof Cordova == 'undefined'))
                alert('Cordova variable does not exist. Check that you have included cordova.js correctly');
            if (typeof CDV == 'undefined')
                alert('CDV variable does not exist. Check that you have included cdv-plugin-fb-connect.js correctly');
            if (typeof FB == 'undefined')
                alert('FB variable does not exist. Check that you have included the Facebook JS SDK file.');
            FB.Event.subscribe('auth.login', function(response) {
                alert('auth.login event');
            });
            FB.Event.subscribe('auth.logout', function(response) {
                alert('auth.logout event');
            });
            FB.Event.subscribe('auth.sessionChange', function(response) {
                alert('auth.sessionChange event');
            });
            FB.Event.subscribe('auth.statusChange', function(response) {
                alert('auth.statusChange event');
            });
            /*function getSession() {
             alert("session: " + JSON.stringify(FB.getSession()));
             }
             */
            function getLoginStatus() {
                FB.getLoginStatus(function(response) {
                    if (response.status == 'connected') {
                        alert('logged in');
                    } else {
                        alert('not logged in');
                    }
                });
            }
            var friendIDs = [];
            var fdata;
            function me() {
                FB.api('/me/friends', {fields: 'id, name, picture'}, function(response) {
                    if (response.error) {
                        alert(JSON.stringify(response.error));
                    } else {
                        var data = document.getElementById('data');
                        fdata = response.data;
                        console.log("fdata: " + fdata);
                        response.data.forEach(function(item) {
                            var d = document.createElement('div');
                            d.innerHTML = "<img src=" + item.picture + "/>" + item.name;
                            data.appendChild(d);
                        });
                    }
                    var friends = response.data;
                    console.log(friends.length);
                    for (var k = 0; k < friends.length && k < 200; k++) {
                        var friend = friends[k];
                        var index = 1;
                        friendIDs[k] = friend.id;
                        //friendsInfo[k] = friend;
                    }
                    console.log("friendId's: " + friendIDs);
                });
            }

            function calculateRating() {
                var score_problem = problem_difficulty * (moves_required / num_of_moves) * (time_given / teim_taken) * (1 / num_tries);
                if (score_problem > 1) {
                    score_problem = 1;
                }
                var total_score = (score_problem + (gold_badge / total_gold_badge) + (silver_badge / total_silver_badge) + (bronze_badge / total_bronze_badge)
                        + (excellent_badge / total_excellent_badge) + badge_of_day / total_days) / 6;

                var rating_grandmaster = 3000;
                var rating = score * rating_grandmaster;
                return rating;
            }

            function logout() {
                FB.logout(function(response) {
                    alert('logged out');
                });
            }

            function startTimer() {
                countDonwn(60);
            }

            function countDown(time) {
                if (time > 0) {
                    setTimeout(function() {
                        countDonwn(time - 1);
                    }, 1000);
                } else {
                    alert('Time up');
                    var rating = calculateRating();
                    updateRating();
                }
            }

            function keepPlaying() {
                startTimer();
            }

            function updateRating(rating) {
                $.ajax({
                    url: 'http://chessgame.orgfree.com/updateRating.php?rating=' + rating,
                    success: function(response) {
                        alert('Rating of user updated');
                    },
                    error: function(response) {
                        alert('Error in updating rating');
                    }
                });
            }

            function createNewUser() {
                var id = 1;
                $.ajax({
                    url: 'http://chessgame.orgfree.com/writeData.php?username=' + user_email,
                    success: function(response) {
                        alert('new user created');
                    },
                    error: function(response) {
                        alert('error in creating new user');
                    }
                });
            }


            function getCurrentUserInfo() {
                FB.api('/me', function(userInfo) {
//                    console.log(userInfo.name + ': ' + userInfo.email);
                    user_name = userInfo.name;
                    user_email = userInfo.email;
                });
            }

            function login() {
                FB.login(
                        function(response) {
                            if (response.session) {
                                alert('logged in');
                                createNewFileInDevice();
                                //TODO: create a new user in database
                                getCurrentUserInfo();
                                createNewUser();
                                startTimer();
                            } else {
                                alert('not logged in');
                            }
                        },
                        {scope: "email"}
                );
            }


            function facebookWallPost() {
                console.log('Debug 1');
                var params = {
                    method: 'feed',
                    name: 'Facebook Dialogs',
                    link: 'https://developers.facebook.com/docs/reference/dialogs/',
                    picture: 'http://fbrell.com/f8.jpg',
                    caption: 'Reference Documentation',
                    description: 'Dialogs provide a simple, consistent interface for applications to interface with users.'
                };
                console.log(params);
                FB.ui(params, function(obj) {
                    console.log(obj);
                });
            }

            function publishStoryFriend() {
                randNum = Math.floor(Math.random() * friendIDs.length);
                var friendID = friendIDs[randNum];
                if (friendID == undefined) {
                    alert('please click the me button to get a list of friends first');
                } else {
                    console.log("friend id: " + friendID);
                    console.log('Opening a dialog for friendID: ', friendID);
                    var params = {
                        method: 'feed',
                        to: friendID.toString(),
                        name: 'Facebook Dialogs',
                        link: 'https://developers.facebook.com/docs/reference/dialogs/',
                        picture: 'http://fbrell.com/f8.jpg',
                        caption: 'Reference Documentation',
                        description: 'Dialogs provide a simple, consistent interface for applications to interface with users.'
                    };
                    FB.ui(params, function(obj) {
                        console.log(obj);
                    });
                }
            }

            $(document).ready(function() {
                try {
                    board = new ChessBoard('board', cfg);
                    loadFen();
                    readText();
                    alert('Device is ready! Make sure you set your app_id below this alert.');
//                    FB.init({appId: "760086264112934", nativeInterface: CDV.FB, useCachedDialogs: false});

                    window.fbAsyncInit = function() {
                        FB.init({
                            appId: '760086264112934',
                            xfbml: false,
                            version: 'v2.1',
                            status: true
                        });
                    };
//                    document.addEventListener('deviceready', function () {
                    var fail = failCB('requestFileSystem');
                    window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, gotFS, fail);
//                    }, false);
//                    document.getElementById('data').innerHTML = "";
                } catch (e) {
                    alert(e);
                }
            });


            var failCB = function(msg) {
                return function() {
                    alert('[FAIL] ' + msg);
                };
            };
            var gotFS = function() {
                var fail = failCB('getFile');
                fs.root.getFile(FILENAME, {create: true, exclusive: false},
                gotFileEntry, fail);
            };
            function gotFileEntry(fileEntry) {
                file.entry = fileEntry;
                fileEntry.createWriter(gotFileWriter, fail);
            }

            function gotFileWriter(fileWriter) {
                file.writer.available = true;
                file.writer.object = fileWriter;
            }

            function saveText(e) {
                var name = 'suraj',
                        desc = 'pandey',
                        fail;
                dbEntries.push('' + name + '' + desc + '&lt;/dd&gt;');
                $('name').value = '';
                $('desc').value = '';
                $('definitions').innerHTML = dbEntries.join('');
                if (file.writer.available) {
                    file.writer.available = false;
                    file.writer.object.onwriteend = function(evt) {
                        file.writer.available = true;
                        file.writer.object.seek(0);
                    };
                    file.writer.object.write(dbEntries.join("n"));
                }
                return false;
            }

            function readText() {
                if (file.entry) {
                    file.entry.file(function(dbFile) {
                        var reader = new FileReader();
                        reader.onloadend = function(evt) {
                            var textArray = evt.target.result.split("n");

                            dbEntries = textArray.concat(dbEntries);
                            alert(dbEntries.join(''));

//                            $('definitions').innerHTML = dbEntries.join('');
                        };
                        reader.readAsText(dbFile);
                    }, failCB("FileReader"));
                } else {
                    isRegistered = false;
                }
            }
            createNewFileInDevice = function() {
                saveText();
//                readText();
            };
//            document.addEventListener('deviceready', function () {
//                try {
//                    alert('Device is ready! Make sure you set your app_id below this alert.');
//                    FB.init({appId: "760086264112934", nativeInterface: CDV.FB, useCachedDialogs: false});
//                    document.getElementById('data').innerHTML = "";
//                } catch (e) {
//                    alert(e);
//                }
//            }, false);
        </script>

    </body>
</html>
